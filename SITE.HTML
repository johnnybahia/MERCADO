<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner IA by Johnny</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .sync-indicator { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #2563eb, #3b82f6); z-index: 50; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Back: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Sheet: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="3" x2="21" y1="15" y2="15"/><line x1="9" x2="9" y1="9" y2="21"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        };

        // Chaves de armazenamento FIXAS
        const STORAGE_KEYS = {
            MARKETS: 'scanner_ia_data_fixed',
            API_KEY: 'scanner_ia_apikey_fixed',
            SHEET_URL: 'scanner_ia_sheet_fixed',
            MODEL_ID: 'scanner_ia_model_fixed'
        };

        // Fun√ß√£o para salvar com seguran√ßa no localStorage
        const safeLocalStorageSet = (key, value) => {
            try {
                const stringValue = JSON.stringify(value);
                const sizeMB = new Blob([stringValue]).size / (1024 * 1024);
                console.log(`üíæ Salvando ${key}: ${sizeMB.toFixed(2)}MB, itens:`, Array.isArray(value) ? value.length : typeof value);

                if (sizeMB > 4) {
                    console.warn("‚ö†Ô∏è Dados muito grandes! Considere limpar fotos antigas.");
                    alert("Aten√ß√£o: Muitos dados. Algumas fotos podem n√£o ser salvas.");
                }

                localStorage.setItem(key, stringValue);

                // VERIFICA√á√ÉO IMEDIATA
                const verificacao = localStorage.getItem(key);
                if (verificacao === stringValue) {
                    console.log(`‚úÖ ${key} CONFIRMADO no localStorage!`);
                    return true;
                } else {
                    console.error(`‚ùå FALHA: ${key} N√ÉO foi salvo corretamente!`);
                    return false;
                }
            } catch (e) {
                console.error(`‚ùå Erro ao salvar ${key}:`, e.message);
                if (e.name === 'QuotaExceededError') {
                    alert("Mem√≥ria cheia! Apague listas antigas ou tire fotos menores.");
                }
                return false;
            }
        };

        // Fun√ß√£o para carregar com seguran√ßa do localStorage
        const safeLocalStorageGet = (key, defaultValue) => {
            try {
                const item = localStorage.getItem(key);
                console.log(`üìñ Tentando carregar ${key}... Encontrado:`, item ? `SIM (${item.length} chars)` : 'N√ÉO');

                if (!item || item === 'undefined' || item === 'null') {
                    console.log(`üì≠ ${key} vazio ou inv√°lido, usando valor padr√£o`);
                    return defaultValue;
                }

                const parsed = JSON.parse(item);
                console.log(`üì¨ ${key} carregado com sucesso! Tipo:`, Array.isArray(parsed) ? `Array[${parsed.length}]` : typeof parsed);
                return parsed;
            } catch (e) {
                console.error(`‚ùå Erro ao carregar ${key}:`, e.message, e);
                console.log('Valor bruto que causou erro:', localStorage.getItem(key)?.substring(0, 100));
                return defaultValue;
            }
        };

        const AVAILABLE_MODELS = [
            { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash (Padr√£o)' },
            { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash (Backup)' }
        ];

        const DEFAULT_SHEET_URL = "https://script.google.com/macros/s/AKfycbweZU05i8l8MTooDU5D2ae9i1SVb4phx19T55haNpQdkAa5QewIS0dIu5HAaNjL6Y_3/exec";

        function App() {
            // Inicializa√ß√£o com Fallback Seguro
            const [markets, setMarkets] = useState(() => {
                console.log("üöÄ Iniciando App...");
                return safeLocalStorageGet(STORAGE_KEYS.MARKETS, []);
            });
            const [sheetUrl, setSheetUrl] = useState(() => safeLocalStorageGet(STORAGE_KEYS.SHEET_URL, DEFAULT_SHEET_URL));
            const [apiKey, setApiKey] = useState(() => safeLocalStorageGet(STORAGE_KEYS.API_KEY, ''));
            const [modelId, setModelId] = useState(() => safeLocalStorageGet(STORAGE_KEYS.MODEL_ID, 'gemini-2.0-flash'));

            const [view, setView] = useState('home');
            const [activeMarketId, setActiveMarketId] = useState(null);
            const [logs, setLogs] = useState([]);
            const [confirmData, setConfirmData] = useState({ show: false, message: '', onConfirm: null });
            
            // UI States
            const [isFetchingKey, setIsFetchingKey] = useState(false);
            const [imgSrc, setImgSrc] = useState(null);
            const [aiData, setAiData] = useState({ name: '', price: '' });
            const [isProcessing, setIsProcessing] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [isSyncing, setIsSyncing] = useState(false);
            const [initialized, setInitialized] = useState(false);

            // Persist√™ncia Imediata com Valida√ß√£o
            useEffect(() => { safeLocalStorageSet(STORAGE_KEYS.MARKETS, markets); }, [markets]);
            useEffect(() => { safeLocalStorageSet(STORAGE_KEYS.API_KEY, apiKey); }, [apiKey]);
            useEffect(() => { safeLocalStorageSet(STORAGE_KEYS.SHEET_URL, sheetUrl); }, [sheetUrl]);
            useEffect(() => { safeLocalStorageSet(STORAGE_KEYS.MODEL_ID, modelId); }, [modelId]);

            const addLog = (msg) => {
                const time = new Date().toLocaleTimeString();
                setLogs(prev => [`[${time}] ${msg}`, ...prev].slice(0, 50));
            };

            // --- AUTO-RESGATE INTELIGENTE ---
            useEffect(() => {
                const autoInit = async () => {
                    if (initialized) return;
                    
                    // Verifica se a chave est√° na mem√≥ria. Se n√£o, tenta buscar na planilha.
                    let currentKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
                    
                    if (!currentKey && sheetUrl) {
                        addLog("Chave n√£o encontrada na mem√≥ria. Buscando na planilha...");
                        setIsFetchingKey(true);
                        try {
                            const response = await fetch(sheetUrl);
                            const data = await response.json();
                            if (data.apiKey) {
                                setApiKey(data.apiKey);
                                localStorage.setItem(STORAGE_KEYS.API_KEY, data.apiKey);
                                addLog("Chave recuperada com sucesso!");
                            }
                        } catch (e) {
                            addLog("Falha no auto-resgate: " + e.message);
                        }
                        setIsFetchingKey(false);
                    }
                    setInitialized(true);
                };
                autoInit();
            }, []);

            // --- MODAL ---
            const requestConfirm = (message, action) => setConfirmData({ show: true, message, onConfirm: action });
            const closeConfirm = () => setConfirmData({ ...confirmData, show: false });
            const handleConfirmAction = () => { if (confirmData.onConfirm) confirmData.onConfirm(); closeConfirm(); };

            const fetchApiKeyFromSheet = async () => {
                if (!sheetUrl) return alert("Insira o Link da Planilha.");
                setIsFetchingKey(true);
                addLog("Buscando chave manual...");
                try {
                    const response = await fetch(sheetUrl);
                    const data = await response.json();
                    if (data.apiKey) {
                        setApiKey(data.apiKey);
                        localStorage.setItem(STORAGE_KEYS.API_KEY, data.apiKey);
                        addLog("Chave atualizada.");
                        alert("Chave carregada com sucesso!");
                    } else {
                        throw new Error(data.error || "Sem chave no retorno");
                    }
                } catch (error) {
                    addLog("Erro busca manual: " + error.message);
                    alert("Erro: " + error.message);
                }
                setIsFetchingKey(false);
            };

            const resizeImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            const MAX = 600; // Reduzido de 800 para 600 para economizar espa√ßo
                            if (w > h && w > MAX) {
                                h *= MAX / w;
                                w = MAX;
                            } else if (h > MAX) {
                                w *= MAX / h;
                                h = MAX;
                            }
                            canvas.width = w;
                            canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            const compressed = canvas.toDataURL('image/jpeg', 0.6); // Qualidade reduzida para 60%
                            console.log(`üì∏ Imagem redimensionada: ${w}x${h}, tamanho: ${(compressed.length / 1024).toFixed(2)}KB`);
                            resolve(compressed);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const callGemini = async (base64Full) => {
                let currentKey = apiKey || localStorage.getItem(STORAGE_KEYS.API_KEY);
                
                if(!currentKey) {
                     alert("Chave API n√£o configurada. O App tentar√° buscar automaticamente na pr√≥xima vez, ou v√° em Configura√ß√µes.");
                     setView('settings');
                     setIsProcessing(false);
                     return;
                }
                
                setStatusMsg(`Lendo...`);
                addLog(`Enviando para ${modelId}...`);
                
                const base64Data = base64Full.split(',')[1];
                const prompt = `Extraia apenas JSON: { "name": "Produto", "price": "10.99" }. Se falhar, string vazia.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${currentKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }] }] })
                    });

                    if (!response.ok) {
                        const errTxt = await response.text();
                        throw new Error(`Erro API: ${response.status} - ${errTxt}`);
                    }
                    
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                    
                    let result = { name: '', price: '' };
                    try {
                        const startIndex = text.indexOf('{');
                        const endIndex = text.lastIndexOf('}');
                        if (startIndex !== -1 && endIndex !== -1) {
                            result = JSON.parse(text.substring(startIndex, endIndex + 1));
                        }
                    } catch (e) { addLog("JSON Parse fail"); }

                    setAiData({ 
                        name: result.name || '', 
                        price: result.price ? String(result.price).replace(',', '.') : '' 
                    });

                } catch (error) {
                    addLog("Erro IA: " + error.message);
                    alert("Erro ao ler imagem (veja logs).");
                }
                setIsProcessing(false);
            };

            const syncItem = async (action, product, marketName) => {
                if (!sheetUrl) return; 
                setIsSyncing(true);
                addLog(`Sync: ${action}`);

                try {
                    await fetch(sheetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: action, 
                            marketName: marketName,
                            product: product,
                            id: product.id 
                        })
                    });
                } catch (e) {
                    addLog("Erro Sync: " + e.message);
                }
                setTimeout(() => setIsSyncing(false), 1000);
            };

            const handleCamera = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsProcessing(true);
                setView('scan');
                const b64 = await resizeImage(file);
                setImgSrc(b64);
                await callGemini(b64);
            };

            const saveProduct = (e) => {
                e.preventDefault();
                const market = markets.find(m => m.id === activeMarketId);
                const newProd = { 
                    id: Date.now(), 
                    name: e.target.pName.value, 
                    price: e.target.pPrice.value.replace(',', '.'), 
                    img: imgSrc 
                };
                setMarkets(markets.map(m => m.id === activeMarketId ? {...m, products: [...m.products, newProd]} : m));
                syncItem('add', newProd, market.name);
                setView('market');
                setImgSrc(null);
            };

            const deleteProduct = (prodId) => {
                requestConfirm("Apagar item?", () => {
                    const market = markets.find(m => m.id === activeMarketId);
                    setMarkets(markets.map(m => m.id === activeMarketId ? {...m, products: m.products.filter(p => p.id !== prodId)} : m));
                    syncItem('delete', { id: prodId }, market.name);
                });
            };

            const deleteMarket = (marketId, e) => {
                e.stopPropagation();
                requestConfirm("Apagar lista?", () => {
                    setMarkets(markets.filter(x => x.id !== marketId));
                });
            };

            // Fun√ß√£o para calcular uso do localStorage
            const getStorageInfo = () => {
                try {
                    let total = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            total += localStorage[key].length + key.length;
                        }
                    }
                    const totalMB = (total / (1024 * 1024)).toFixed(2);
                    const marketsSize = localStorage.getItem(STORAGE_KEYS.MARKETS)?.length || 0;
                    const marketsMB = (marketsSize / (1024 * 1024)).toFixed(2);
                    return { totalMB, marketsMB, marketsCount: markets.length };
                } catch (e) {
                    return { totalMB: '?', marketsMB: '?', marketsCount: 0 };
                }
            };

            const clearAllData = () => {
                if (confirm("‚ö†Ô∏è APAGAR TUDO? Isso vai limpar todas as listas e configura√ß√µes!")) {
                    localStorage.clear();
                    window.location.reload();
                }
            };

            const testLocalStorage = () => {
                console.log("üß™ === TESTE DE LOCALSTORAGE ===");
                console.log("Total de listas em mem√≥ria:", markets.length);
                console.log("Conte√∫do atual do state markets:", markets);

                // For√ßa salvamento
                const saved = safeLocalStorageSet(STORAGE_KEYS.MARKETS, markets);
                if (saved) {
                    // Tenta recarregar
                    const reloaded = safeLocalStorageGet(STORAGE_KEYS.MARKETS, []);
                    console.log("Listas recarregadas:", reloaded.length);

                    if (reloaded.length === markets.length) {
                        alert(`‚úÖ TESTE OK! ${markets.length} listas salvas e recarregadas com sucesso!`);
                    } else {
                        alert(`‚ùå ERRO! Salvou ${markets.length} mas recarregou ${reloaded.length}`);
                    }
                } else {
                    alert("‚ùå FALHA AO SALVAR! Veja o console.");
                }
            };

            // Salvar antes de fechar a p√°gina
            useEffect(() => {
                const handleBeforeUnload = () => {
                    console.log("üö™ Salvando antes de fechar...");
                    safeLocalStorageSet(STORAGE_KEYS.MARKETS, markets);
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [markets]);

            // --- RENDERIZA√á√ÉO ---
            if (view === 'settings') {
                const storageInfo = getStorageInfo();
                return (
                    <div className="max-w-md mx-auto min-h-screen bg-gray-50 p-6 flex flex-col">
                        <h2 className="text-xl font-bold mb-4 text-gray-800">Configura√ß√µes</h2>

                        {/* Info de Armazenamento */}
                        <div className="bg-gradient-to-br from-purple-50 to-blue-50 p-4 rounded-xl mb-4 border border-purple-200">
                            <h3 className="text-xs font-bold text-purple-700 uppercase mb-2">üìä Uso de Mem√≥ria</h3>
                            <div className="text-sm space-y-1">
                                <div className="flex justify-between"><span className="text-gray-600">Total usado:</span> <span className="font-bold">{storageInfo.totalMB} MB / ~5 MB</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">Listas:</span> <span className="font-bold">{storageInfo.marketsMB} MB ({storageInfo.marketsCount} listas)</span></div>
                                {parseFloat(storageInfo.totalMB) > 4 && <div className="text-red-600 text-xs font-bold mt-2">‚ö†Ô∏è Mem√≥ria quase cheia! Apague listas antigas.</div>}
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm mb-6 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-green-600 uppercase flex items-center gap-1"><Icons.Sheet size={14}/> Link da Planilha</label>
                                <input value={sheetUrl} onChange={(e) => setSheetUrl(e.target.value)} className="w-full p-3 border border-green-200 rounded-lg mt-1 text-sm" />
                            </div>
                            <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Chave API</label>
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-sm font-mono text-gray-600">
                                        Status: {apiKey ? <span className="text-green-600 font-bold">Carregada</span> : <span className="text-red-500">Vazia (Auto-Busca ativa)</span>}
                                    </span>
                                </div>
                                <button onClick={() => fetchApiKeyFromSheet()} disabled={isFetchingKey} className="w-full p-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded flex justify-center items-center gap-2 text-sm">
                                    {isFetchingKey ? "Buscando..." : <><Icons.Refresh size={16}/> Recarregar Manualmente</>}
                                </button>
                            </div>

                            {/* Bot√£o de Teste */}
                            <button onClick={testLocalStorage} className="w-full p-2 bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold rounded text-sm border border-blue-300">
                                üß™ Testar Salvamento (Ver Console F12)
                            </button>

                            {/* Bot√£o de Limpar Tudo */}
                            <button onClick={clearAllData} className="w-full p-2 bg-red-100 hover:bg-red-200 text-red-700 font-bold rounded text-sm border border-red-300">
                                üóëÔ∏è Limpar Toda Mem√≥ria (Reset Completo)
                            </button>

                            <button onClick={() => setView('home')} className="w-full p-3 bg-blue-600 text-white font-bold rounded-lg mt-2">Voltar</button>
                        </div>
                        <div className="flex-1 bg-gray-900 text-green-400 p-4 rounded-xl text-[10px] font-mono h-40 overflow-y-auto">
                            {logs.map((log, i) => <div key={i} className="mb-1 border-b border-gray-800 pb-1 break-words">{log}</div>)}
                        </div>
                    </div>
                );
            }

            if (view === 'scan') {
                return (
                    <div className="max-w-md mx-auto min-h-screen bg-black flex flex-col">
                        <div className="flex-1 relative bg-zinc-900 flex items-center justify-center overflow-hidden">
                            {imgSrc && <img src={imgSrc} className="max-w-full max-h-[50vh] object-contain opacity-50" />}
                            {isProcessing && <div className="absolute inset-0 flex flex-col items-center justify-center z-50 p-4 text-center text-white"><div className="bg-blue-600 p-4 rounded-full mb-4 animate-pulse-slow"><Icons.Sparkles className="w-8 h-8"/></div><h3>{statusMsg}</h3></div>}
                        </div>
                        {!isProcessing && (
                            <div className="bg-white rounded-t-3xl p-6 pb-10 slide-up">
                                <form onSubmit={saveProduct} className="space-y-4">
                                    <h3 className="text-lg font-bold text-gray-800 flex justify-between">Resultado <button type="button" onClick={() => setView('market')} className="text-gray-400"><Icons.Back/></button></h3>
                                    <input name="pName" defaultValue={aiData.name} className="w-full p-3 bg-gray-50 border rounded-xl" placeholder="Produto" />
                                    <input name="pPrice" type="number" step="0.01" defaultValue={aiData.price} className="w-full p-3 bg-gray-50 border rounded-xl text-2xl font-bold text-green-700" placeholder="0.00" />
                                    <button type="submit" className="w-full bg-green-600 text-white font-bold py-4 rounded-xl">Confirmar e Salvar</button>
                                </form>
                            </div>
                        )}
                    </div>
                );
            }

            if (view === 'market') {
                const market = markets.find(m => m.id === activeMarketId);
                const total = market ? market.products.reduce((acc, p) => acc + parseFloat(p.price||0), 0) : 0;
                return (
                    <div className="max-w-md mx-auto h-screen flex flex-col bg-gray-50">
                        {isSyncing && <div className="sync-indicator"></div>}
                        <div className="bg-white p-4 shadow-sm flex items-center justify-between sticky top-0 z-10">
                            <button onClick={() => setView('home')} className="p-2 text-gray-600"><Icons.Back /></button>
                            <h2 className="font-bold text-lg truncate">{market?.name}</h2>
                            <div className={`text-xs font-bold ${isSyncing ? 'text-blue-600' : 'text-green-500'}`}>{isSyncing ? 'Sync...' : 'Online'}</div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 pb-32 hide-scrollbar">
                            {market?.products.length === 0 ? <div className="text-center text-gray-400 mt-20"><p>Lista vazia.</p></div> : 
                                market.products.map(p => (
                                    <div key={p.id} className="bg-white p-3 mb-3 rounded-xl shadow-sm flex items-center gap-3">
                                        <div className="w-12 h-12 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center">{p.img ? <img src={p.img} className="w-full h-full object-cover"/> : <span className="text-xs text-gray-400">Foto</span>}</div>
                                        <div className="flex-1 min-w-0"><div className="font-medium truncate">{p.name}</div><div className="text-lg font-bold text-green-600">R$ {p.price.replace('.', ',')}</div></div>
                                        <button onClick={() => deleteProduct(p.id)} className="text-red-300 p-2"><Icons.Trash /></button>
                                    </div>
                                ))
                            }
                        </div>
                        <div className="fixed bottom-0 w-full max-w-md bg-white border-t p-4 pb-8 rounded-t-2xl shadow-lg">
                            <div className="flex justify-between items-end mb-4 px-2"><span className="text-gray-500 text-sm">Total</span><span className="text-3xl font-bold text-gray-800">{total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></div>
                            <label className="flex items-center justify-center bg-blue-600 text-white py-4 rounded-xl shadow-lg cursor-pointer active:scale-95 transition-transform"><Icons.Camera /> <span className="ml-2 font-bold text-lg">Escanear</span><input type="file" accept="image/*" capture="environment" className="hidden" onChange={handleCamera} /></label>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto min-h-screen pb-10">
                    {confirmData.show && (
                        <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-full modal-enter">
                                <h3 className="text-lg font-bold mb-2">Confirma√ß√£o</h3>
                                <p className="text-gray-600 mb-6">{confirmData.message}</p>
                                <div className="flex gap-3">
                                    <button onClick={closeConfirm} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl">Cancelar</button>
                                    <button onClick={handleConfirmAction} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="bg-gradient-to-br from-blue-700 to-blue-600 text-white p-6 rounded-b-3xl shadow-lg mb-6">
                        <div className="flex justify-between items-start mb-3">
                            <div><h1 className="text-2xl font-bold flex items-center gap-2">üõí Scanner IA by Johnny</h1><p className="opacity-80 text-sm">Or√ßamento Inteligente</p></div>
                            <button onClick={() => setView('settings')} className="p-2 bg-white/10 rounded-full"><Icons.Settings /></button>
                        </div>
                        <div className="bg-white/10 px-3 py-2 rounded-lg text-xs">
                            üíæ <strong>{markets.length}</strong> lista{markets.length !== 1 ? 's' : ''} salva{markets.length !== 1 ? 's' : ''} na mem√≥ria
                        </div>
                    </header>
                    <div className="px-4">
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            const name = e.target.marketName.value.trim();
                            if(name) { setMarkets([{ id: Date.now(), name, date: new Date().toLocaleDateString('pt-BR'), products: [] }, ...markets]); e.target.reset(); }
                        }} className="flex gap-2 mb-6">
                            <input name="marketName" placeholder="Novo Mercado..." className="flex-1 p-3 rounded-xl border shadow-sm" required />
                            <button type="submit" className="bg-green-500 text-white p-3 rounded-xl shadow-sm"><Icons.Plus /></button>
                        </form>
                        <div className="space-y-3">
                            {markets.map(m => (
                                <div key={m.id} onClick={() => { setActiveMarketId(m.id); setView('market'); }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer">
                                    <div><h3 className="font-bold text-gray-800">{m.name}</h3><p className="text-xs text-gray-500">{m.products.length} itens ‚Ä¢ {m.date}</p></div>
                                    <button onClick={(e) => deleteMarket(m.id, e)} className="text-red-300 p-2"><Icons.Trash /></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
